## 游戏手柄控制的ESP8266遥控车(遥控器+接收机)

### 进度
+ 2023.1.2未完全完成。软件部分基本完成，等快递中，可能还要买几个三极管。
+ 2023.1.5设计了5个电调/舵机接口，更新代码。
+ 2023.1.9可以运行。电调和电机到了，电路焊好了，测试后修改一部分代码。
+ 2023.1.15支持舵机转向。
+ 2023.1.22新的4G版服务器&客户端开发中，优化了一些逻辑。使用mpu6050辅助控制舵机。

### 计划
>+ ~~2023.1.15 用了django做服务端~~
>+ 2023.1.22 服务端直接用了socket，客户端代码还没有完成。
>+ 2023.1.22 超声波测距防止碰撞

### 文件
+ 【可用】server_controler.py 双电机差速
+ 【可用】server_controler_steering.py  舵机转向
+ 【不可用】server_controler_steering_4G.py   舵机转向、4G连接

### 简介
+ 内网wifi连接（外网4G连接开发中）
+ 电调&舵机控制
+ 游戏手柄控制
+ 失联保护，自动重连
+ 电池电压回传，低电压报警
+ mpu6050辅助控制方向 (./esp8266/mpu6050使用了<a href='https://github.com/adamjezek98/MPU6050-ESP8266-MicroPython'>adamjezek98大佬的作品</a>）


![参考](晒晒成品.png)
（NodeMcu，A0测电压<=3.3V，电调信号推荐用D1、2、5、6、7。接12v注意A0电压，需要加个电阻。）
### 使用方法
>1.准备
>>1.1 打开```./esp8266/main.py```  
>>1.2 设置WiFi：找到
>>```python
>>do_connect('SSID', 'Passwd')
>>```  
>>填进ssid和密码。  
>>1.3 设置遥控器地址：找到
>>```python
>>addressList=['192.168.10.24','192.168.10.112']
>>```  
>>修改地址为作为遥控端的电脑，可以放多个。  
>>1.3 刷MicroPython的bin，再把sep8266文件夹里的文件烧进去。(*推荐用uPyCraft，可以自动下载固件，操作也很方便。*)  
>>1.4 安装一个好用的库叫pygame，可以读取手柄的数据还可以开发小游戏的图形界面。大赞！
>>```
>>pip install pygame
>>```
>2.开始
>>2.1 运行serverWithControler.py（差速）或者serverWithControler_steering.py（舵机+电机）。如果手柄也连上了，电脑会作为server等待8266响应。  
>>2.2 按一下RST，会开始闪LED（如果没闪说明板子不一样，可能要改一下```./sep8266/main.py```里Pin的值才能用。）  
>>2.3 连上会一直print信息，摇手柄摇杆电机应该会开始转了（如果电调要解锁，需要手动推杆、设定油门中位等）。

>3.油门微调  
>需要同时按两个键,测试用的是任天堂SWITCH Pro Controler，它的X、Y、A、B按键是和xbox、ps手柄的位置不一样的。用到这些按键可能和我设计的是反着的。
>>*（收到电调后测试发现：每个电调是不一样的，只识别高电平时间。我买到的两个识别到的时间分别是0.98ms至2.25ms中间值是1.62ms， 1.02ms至2.20ms中间值是1.49ms。所以推荐手动修改```config.txt```，想改变旋转方向，只要调换一下mi和ma的值。*  
>>3.1 双向电调油门中位调整  
>>电机1：***按住***手柄十字左，再按X或B键  
>>电机2：***按住***手柄十字右，再按X或B键  
>>3.2 油门上下限   
>>电机1：***按住***手柄十字上，再按Y、A或X、B键  
>>电机2：***按住***手柄十字下，再按Y、A或X、B键 

### 如何控制电调
+ 电调只看高电平时间，不关心频率，50Hz不够精准推荐100Hz。  
+ 单向电调1ms-2ms对应0-100%，双向1ms-1.5ms2ms对应(-100%)-0-100%。不会是一点不差的时间，电调间有差异。  
+ 全低电平停转  
+ 超出范围电机会被调成最大或最小  

### 其他
+ 有过滤手柄漂移、过滤摇杆归位后的回弹产生数据的代码。是否会造成不灵敏需要再测试一下。
+ 一个理念是放在esp8266的代码最小化。第一次：client发送```51```，server会回复```[51,{'pin':5,'freq':50},{'pin':4,'freq':50},{},{},{}]```决定启用哪几个pin以及它们的频率。之后client会发送目前状态```{'duty1': 76, 'duty0': 76, 'adc': 0, 'sle': 0.1}```。遥控器微调、算占空比等都在电脑上完成，汇总成```{'freq': None, 'duty0': None, 'duty1': None, 'sle': None, 'mes': None}```发回client,8266会不加甄别直接应用。如过要改程序，只需要改电脑上的server。
+ 另一个想法是尽量减少它处理的数据量。如果发送的数据没有变化，它就不会被发到8266上。
+ Micro Python太好用啦，我吹爆。
+ 写了一个休眠的机制，~~不操作时轮询率是10Hz(发现不灵敏，已删）~~，动摇杆后升为100Hz(*测试时设成1000Hz也没有问题*)，如果长时间不动会降为0.2Hz，超过一定时间会自动断开连接并关掉PWM。